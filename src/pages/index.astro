---
import MainLayout from "@layouts/MainLayout.astro";
import Hero from "@elements/Hero.astro";
import Advantages from "@elements/Advantages.astro";
import About from "@elements/About.astro";
import Analytics from "@elements/Analytics.astro";
import Tasks from "@elements/Tasks.astro";
import Blog from "@elements/Blog.astro";
import Promo from "@elements/Promo.astro";
---

<MainLayout
	lang="en"
	title="Whirl | Home page"
>
	<Hero />
	<Advantages />
	<About />
	<Analytics />
	<Tasks />
	<Blog />
	<Promo />
</MainLayout>

<script>
	var isOpen = false;
	var noTransition = false;
	var overlayElement: any = document.querySelector("[data-js-header-overlay]");
	var buttonElement: any = document.querySelector("[data-js-header-button]");
	var externalElements = [
		document.querySelector("[data-js-main]"),
		document.querySelector("[data-js-footer]"),
		document.querySelector("[data-js-header-home-button]"),
	];

	window.onload = function () {
		setTimeout(function () {
			matchDevice();
			bindEvents();
		}, 4000);
	};

	function matchDevice() {
		if (window.matchMedia("(max-width: 767px)").matches) {
			document.documentElement.addEventListener("keydown", handleEsc);
			buttonElement.removeAttribute("hidden");
			overlayElement.setAttribute("tabindex", "-1");
			overlayElement.setAttribute("role", "dialog");
			overlayElement.setAttribute("aria-modal", "true");
			overlayElement.setAttribute("inert", "");
		} else {
			document.documentElement.removeEventListener("keydown", handleEsc);
			buttonElement.setAttribute("hidden", "");
			overlayElement.removeAttribute("tabindex");
			overlayElement.removeAttribute("role");
			overlayElement.removeAttribute("aria-modal");
			overlayElement.removeAttribute("inert");
		}
	}

	var handleEsc = (e: any) => {
		if (e.key === "Escape") {
			onButtonClick();
		}
	};

	var onButtonClick = () => {
		isOpen = !isOpen;
		document.documentElement.classList.toggle("is-lock");
		buttonElement.classList.toggle("is-active");
		overlayElement.classList.toggle("is-active");
		buttonElement.setAttribute("title", isOpen ? "Close menu" : "Open menu");
		buttonElement.setAttribute("aria-label", isOpen ? "Close menu" : "Open menu");
		buttonElement.toggleAttribute("aria-expanded", isOpen);
		overlayElement.toggleAttribute("inert");
		externalElements.forEach((element: any) => {
			element.toggleAttribute("inert");
		});
	};

	function bindEvents() {
		buttonElement.addEventListener("click", onButtonClick);

		window.addEventListener("resize", () => {
			if (!noTransition) {
				overlayElement.classList.add("no-transition");
				noTransition = true;
			}
			debouncedMatchDevice();
			debouncedRemoveTransition();
		});
	}

	var debouncedMatchDevice = debounce(matchDevice, 2000);
	var debouncedRemoveTransition = debounce(removeTransition, 2000);

	function removeTransition() {
		overlayElement.classList.remove("no-transition");
		noTransition = false;
	}

	function debounce(fn: any, delay: any) {
		let timer: any;
		return function (this: any, ...args: any[]) {
			clearTimeout(timer);
			timer = setTimeout(() => {
				fn.apply(this, args);
			}, delay);
		};
	}
</script>
